# temporary build directory

### 빌드 디렉토리

주요 빌드 디렉토리는 다음과 같다.
* conf : 포키와 비트베이크를 설정하기 위한 환경설정 파일을 갖고 있다.
* downloads : 다운로드된 압축 파일을 저장한다.
* sstate-cache : 패키지된 데이터 스냅샷을 갖고 있다. 주로 빌드 과정에서 속도를 높이기 위해 사용되는 캐시이다.
* tmp : 임시 빌드 디렉토리이다.

빌드 과정에서 비트베이크는 여러 작업을 수행하고 빌드 디렉토리를 계속 수정한다. 자주 사용하는 절차는 다음과 같다.
* 다운로드 : 소스코드를 다운로드하여 build/downloads 디렉토리에 압축 파일을 생성한다.
* 소스준비 : 다운로드한 소스코드를 사용하기 위하여 준비한다. 예를 들어 압축 파일의 압축을 풀어 build/tmp/work 디렉토리에 소스코드를 준비하고 필요 시 수정사항을 적용한다.
* 환경설정 및 빌드 : 빌드 옵션을 설정 하고 빌드한다.
* 설치 : 빌드 결과물을 build/tmp/work/.../image 의 적절한 디렉토리에 설치한다.
* sysroot 복사 : 크로스컴파일을 하기 위해 공유될 필요가 있는 라이브러리, 헤더, 그 외의 파일들을 build/tmp/work/.../recipe-sysroot와 build/tmp/work/.../recipe-sysroot-native 디렉토리에 복사한다.
* 패키지 생성 : 설치된 결과물을 사용하여 하위 패키지에서 파일 분리, 패키지 생성 단계를 거쳐 패키지를 만든다.

### 임시 빌드 디렉토리

임시 빌드 디렉토리는 빌드가 시작된 직후에 만들어진다. 대표적인 내용들은 다음과 같다.
* deploy : 이미지, 패키지, SDK와 같은 빌드 결과물을 갖고 있다.
* sysroots : 빌드 과정 중 사용되는 공유 라이브러리, 헤더, 유틸리티를 갖고 있다.
* work : 작업 중인 소스코드, 작업 환경설정, 실행 로그, 생성된 패키지의 내용물을 포함한다.

### work 디렉토리

build/tmp/work 디렉토리는 아키텍처에 따라 구성돼 있다. 예를 들어 qemuarm 머신과 관련된 작업을 하면 다음 디렉토리를 볼 수 있다.
* all-poky-linux : 아키텍처에 독립적인 패키지들을 위한 작업 빌드 디렉토리다.
* armv5te-poky-linux-gnueabi : 아키텍처 특화된 패키지들이 포함되어 있다.
* qemuarm-poky-linux-gnueabi : 머신에 특화된 패키지들이 포함되어 있다.
* x86_64-linux : 호스트 sysroot 내용물을 빌드하기 위해 사용한다.

work 작업 디렉토리는 비정상적인 동작이나 빌드가 실패할 경우 점검할 때 유용하다. 이 내용물은 다음 패턴에 따라 하위 디렉토리에 저장된다.
```bash
<arch>/<recipe name>/<software version>
```
이 내부의 디렉토리 구조는 다음과 같다.
* < sources > : 빌드를 하기 위해 압축이 풀린 소프트웨어 소스코드가 있다. 이 디렉토리는 WORKDIR 변수에 정의돼 있다.
* 레시피에 의해 설치된 파일을 갖고 있다.
* 패키지의 압축 풀린 내용물이 저장돼 있다.
* apckages-split : 압축이 풀리고 나눠진 패키지 내용물이 저장돼 있다. 각 패키지를 위한 하위 디렉토리를 갖고 있다.
* temp : 비트베이크 작업 코드와 실행 로그가 저장돼 있다.

작업을 수행하다보면 크로스 컴파일하는 동안 호스트와 타깃에서 사용하는 컴파일러, 유틸리티, 라이브러리르 담고 있는 sysroots 디렉토리를 자주 확인하게 된다.
또한 작업 중인 빌드 디렉토리를 파악하기 위하여 build/tmp/work 디렉토리를 확인하게 된다.

### sysroot 디렉토리

procps 레시피를 빌드하면 다음과 같이 recipes-sysroot와 recipes-sysroot-native 디렉토리를 볼 수 있다.
![procps-sysroot]()
이 디렉토리에는 각 sysroot에 설치된 패키지가 있다. recipes-sysroot에는 타깃에서 사용하는 헤더와 라이브러리가 있고, recipes-sysroot-native에는 빌드하는 동안 호스트 시스템에서 사용하는 도구가 들어가 있다.
빌드 과정에서 헤더를 빠트리거나 링크가 실패된 것을 알았을 때 호스트와 타깃의 sysroot 내용물이 정확한지 다시 한번 확인해야 한다.
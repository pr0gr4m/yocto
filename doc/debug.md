# yocto debugging

yocto 프로젝트 디버깅 시에는 대상이 무엇인지 명확히 해야한다. 
메타데이터 디버깅은 비트베이크 작업이 적절히 수행했는지 검증한다. 이 경우 관련된 작업의 로그 파일을 사용한다.
런타임 디버깅은 애플리케이션, 라이브러리 또는 커널의 개발 주기 동안 디버깅을 하는 것과 같다. 이 경우 디버거나 코드 측정 장치 등을 사용한다.

### 빌드 히스토리

빌드 히스토리는 poky를 사용하는 동안 여러 빌드 결과에 대한 내용물의 히스토리를 갖고 있다. 이 히스토리로 패키지, 이미지, SDK 빌드를 추적할 수 있다.
시스템에서 빌드 히스토리 기능을 활성화하기 위해 build/conf/local.conf 파일에서 다음과 같은 코드를 추가해야 한다.
```bash
INHERIT += "buildhistory"
BUILDHISTORY_COMMIT = "1"
```
INHERIT 지시어는 빌드 과정에서 buildhistory 클래스를 추가한다. BUILDHISTORY_COMMIT은 비트베이크가 매번 새로운 패키지, 이미지 또는 SDK 빌드를 위해 buildhistory 저장소에 새로운 git commit 하는 것을 활성화시킨다. 이것은 두 커밋 사이에서 git diff를 하여 쉽게 변경 사항을 추적할 수 있다.
모든 패키지, 이미지, SDK들의 빌드된 데이터를 사용해 추가 정보를 쉽게 추출하기 위해 build/buildhistory 디렉토리에 텍스트 파일로 저장된다. poky는 두 개의 buildhistory 상태의 다른 점을 보기 위해 buildhistory-diff 유틸리티를 제공한다.
패키지가 빌드될 때 buildhistory는 생성된 하위 패키지들 목록, 설치 스크립트, 파일 소유자 및 크기의 목록, 의존성 등을 생선한다. 이미지와 SDK에서 패키지들 간의 의존성 관계, 파일시스템 파일, 의존성 그래프가 생성된다.

### 패키지 디버깅

복잡한 레시피에서는 여러 하위 패키지로 설치된 내용물을 분리한다. 레시피의 내용물이 분리되는 방법을 알기 위해 ```build/tmp/work/<arch>/<recipe_name>/<software-version>/packages-split``` 디렉토리를 살펴본다. 이 디렉토리는 모든 하위 패키지가 하위 디렉토리를 포함하고, 하위 트리에 가보면 그 내용물이 있다. 내용물이 분리가 잘 안 됐을 경우 가능한 이유는 다음과 같다.
* 내용물이 설치되지 않았다.
* 애플리케이션 또는 라이브러리 환경설정 에러
* 메타데이터 에러

주로 라이브러리 레시피에서 많이 발생하는 문제는 필요한 결과물(예를 들어 헤더 또는 동적 라이브러리)이 sysroot 디렉토리에 이용 가능하게 생성되지 않아 빌드가 깨지는 것이다. sysroot 생성에 관련된 것은 ```build/tmp/<arch>/<recipe_name>/<software-version>/sysroot-destdir``` 에서 볼 수 있다.

### devshell

패키지를 수정하거나 빌드 실패를 디버깅할 때 devshell이 유용하다. devshell을 사용할 때 소스 파일은 작업 디렉토리에 압축이 풀리고, 패치가 적용되며, 새로운 터미널이 열린다. 그리고 현재 위치가 작업 디렉토리로 설정된다. 새로운 터미널에서 빌드에 필욯나 모든 환경 변수는 정의돼 있으며, configure와 make같은 명령어를 사용할 수 있다. 빌드 시스템이 해당 명령어들을 실행하는 것처럼 실행된다.
다음 명령어는 linux-yocto 타깃으로 devshell을 사용하는 예다.
```console
$ bitbake linux-yocto -c devshell
```
devshell은 작은 작업에는 유용하지만 큰 작업은 일반 개발 방법론에서 사용하는 외부 툴체인을 사용하고, 그 결과를 레시피에 패치로 통합하는 것이 좋다.

### GDB

GDB는 poky에서 패키지처럼 사용할 수 있고, 기본적으로 SDK 이미지에 설치할 수도 있다. IMAGE_FEATURES 변수에 tools-debug와 dbg-pkgs를 추가한다.
디버깅 패키지와 도구가 설치된 SDK나 이미지 사용은 타깃에서 직접 애플리케이션 디버깅을 할 수 있게 해준다.
메모리 제약으로 인하여 GDB를 사용할 때 일부 제약 조건들이 생길 수 있다.